<%-include("../partials/head")%>
<%-include("../partials/header")%>
<div class="container content" id="bodySub">
    <h2>{{namePage}}</h2>
   <subgenre-book :list-book="listBook" :handler-buy="handlerBuy" :author-one="authorOne" :handle-change-author="handleChangeAuthor"></subgenre-book>
</div>
<script>
    const bodySub = Vue.createApp({
        data(){
            return{
                idSubgenre:0,
                namePage:"",
                listBook:[],
                authorOne:[]
            }
        },
        methods:{
            async getBook(){
                const res = await fetch(`/buyer/json/get-book-from-subgenre/${this.idSubgenre}`)
                if(res.ok)
                {
                    const buffer = await res.json()
                    this.listBook = buffer.bookList
                    this.namePage = buffer.namePage.name
                }
            },
            getIdSubgenre(){
                this.idSubgenre = Number(new URL(location.href).searchParams.get('id')) 
            },
            async handlerBuy(item){
                location.href = 'http://localhost:9001/content/get-book/'+item.id           
            },
            getAuthorOne(){
                const buffer = []
                for(let i = 0; i<this.listBook.length; i++){
                   if(!this.authorOne.find(q=>q.authorName===this.listBook[i].authorName)){
                    this.authorOne.push(this.listBook[i])
                   }
                }

            },
            handleChangeAuthor(){
                
            }
        },
        async mounted(){
            await this.getIdSubgenre()
            await this.getBook()
            this.getAuthorOne()
        }
    })
    bodySub.component('subgenre-book',{
        props:['listBook','handlerBuy','authorOne','handleChangeAuthor'],
        template:`
             <div class="row">
                 <div class="col-3">
                        <h3>
                            Автор
                        </h3>
                        <div class="form-check" v-for="item in authorOne">
                            <input class="form-check-input" type="checkbox" value="" id="defaultCheck1" @change="handleChangeAuthor(item)">
                            <label class="form-check-label" for="defaultCheck1">
                                {{item.authorName +' ' +item.lastname}}
                            </label>
                        </div>
                    </div>
               <div class="col">
                 <div class="row ">
                     <div class="d-flex flex-column col-3 mt-4"  v-for="item in listBook">
                        <img class="w-100"  height="280"  :src="'http://localhost:9001/get-image/'+item.id+'.jpg'">
                        <div v-if="item.discount!==null" class="fw-bold fs-4">
                        {{Math.floor(item.price-item.price*(item.discount/100))+"₽"}}<del class="mx-2">{{item.price+"₽"}}</del>
                        </div>
                        <div v-else class="fw-bold fs-4">
                        {{item.price+"₽"}}
                        </div>
                        <div class="fs-6">
                        {{item.name}}
                        </div>
                        <div class="fs-8 fw-light">
                        {{item.authorName +' ' +item.lastname}}
                        </div>
                        <button type="button" class="align-self-end mt-auto btn btn-primary w-100" @click="handlerBuy(item)">Купить</button>  
                    </div>

                </div>
              
            </div>
        </div>
        `
    })
    bodySub.mount('#bodySub')
</script>
<%-include("../partials/footer")%> 